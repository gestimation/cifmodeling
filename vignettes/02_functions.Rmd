---
title: "Main functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Main functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# Load required packages for the vignette
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/vignette-",
  fig.width  = 6,   
  fig.height = 4,   
  dpi        = 300,     
  fig.retina = 2,       
  out.width  = "70%",   
#  dev = "ragg_png",     
  comment = "#>"
)

.has_cifmodeling <- requireNamespace("cifmodeling", quietly = TRUE)
if (.has_cifmodeling) {
library(cifmodeling)
}
set.seed(1)
```

<!-- badges: start --> <!-- badges: end -->

```{r setup, include=FALSE, warning=FALSE}
#pak::pak("gestimation/cifmodeling")
#devtools::install_github("gestimation/cifmodeling") 
#library(cifmodeling)
library(nleqslv)
library(boot)
library(ggplot2)
library(ggsurvfit)
library(patchwork)
```

## Main functions

### cifplot()

This function produces the **Kaplan–Meier survival** or **Aalen–Johansen cumulative incidence** curve from a unified formula + data interface. It auto-labels axes based on `outcome.type` and `type.y` (`"risk"` for 1-survival or CIF), can add censoring/competing-risk/intercurrent-event marks, and returns a regular ggplot object (compatible with + and %+%). You may also pass a survfit-compatible object directly.

**Typical use cases**

-   Draw one survival/CIF curve set by exposure groups (e.g., treatment vs control).
-   Call `cifpanel()` with a simplified code to create a panel displaying plots of multiple stratified survival/CIF curves or CIF curves for each event type.
-   Add confidence intervals and censor/competing-risk/intercurrent-event marks.
-   Add a risk table to display the number at risk or the estimated survival probabilities or CIFs and 95% confidence intervals at each point in time.

**Key arguments shared with cifcurve()**

-   **Outcome type and estimator**
    -   `formula` A model formula specifying the time-to-event outcome on the left-hand side (`Event(time, status)` or `Surv(time, status)`) and, optionally, a stratification variable on the right-hand side. 
    -   `outcome.type = "survival"` → Kaplan–Meier estimator
    -   `outcome.type = "competing-risk"` → Aalen–Johansen estimator
-   **Confidence intervals**
    -   `conf.int` sets the two-sided level (default 0.95)\
    -   `conf.type` chooses the transformation (`"arcsine-square root"`, `"plain"`, `"log"`, `"log-log"`, `"logit"`, or `"none"`)
    -   `error` chooses the estimator for standard error (`"greenwood"` or `"tsiatis"` for survival curves and `"delta"` or `"aalen"` for CIFs)

**Key arguments for cifplot()**

-   **Data visualization**
    -   `add.ci` adds confidence intervals on the ggplot2-based plot
    -   `add.competing.risk.mark` and `add.intercurrent.event.mark` add symbols to describe competing risks or intercurrent events in addition to conventional censoring marks with `add.censor.mark`
    -   `add.risktable` adds numbers at risk
    -   `add.estimate.table` adds estimates and 95% confidence interval
    -   `add.quantile` adds a line that represents median or quantile

-   **Plot customization**
    -   `type.y` chooses y-axis (`"surv"` for survival and `"risk"` for 1-survival or CIF)
    -   `limits.x`, `limits.y`, `breaks.x`, `breaks.y` numeric vectors for axis control
    -   `style` specifies the appearance of plot (`"CLASSIC"`, `"BOLD"`, `"FRAMED"`, `"GRID"`, `"GRAY"` or `"GGSURVFIT"`)

-   **Panel display**
    -   `panel.per.variable` produces multiple survival/CIF curves per stratification variable specified in the formula
    -   `panel.per.event` produces CIF curves for each event type
    -   `panel.censoring` produces KM-type curves for (event, censor) and (censor, event) so that censoring patterns can be inspected
    -   `panel.mode` uses automatic panel mode

**Return**

-   A **ggplot** object.

**Under the hood: cifcurve()**

`cifplot()` is a streamlined, opinionated wrapper around `cifcurve()`, which calculates the Kaplan–Meier estimator and the Aalen–Johansen estimator. `cifcurve()` returns a survfit-compatible object, enabling an independent use of standard methods such as:

-   `summary()` — time-by-time estimates with standard errors and confidence intervals
-   `plot()` — base R stepwise survival/CIF curves
-   `mean()` — restricted mean survival estimates with confidence intervals
-   `quantile()` — quantile estimates with confidence intervals

Furthermore, the cifmodeling package provides a workflow for a **ggplot2-based visualization** based on the survfit-compatible objects by passing them to `cifplot()` and `cifpanel`. 

### cifpanel()

`cifpanel()` arranges multiple `cifplot()/cifcurve()` results into a unified grid layout with consistent scales, shared legend, and synchronized themes. It is ideal for visual comparison across outcomes, time scales, or strata. The inset feature also allows you to display another plot within a plot.

**Typical use cases**
-   Compare CIF (event 1) vs CIF (event 2) in a 1×2 layout.

-   Compare survival/CIF curves across strata with a shared legend and matched axes.

-   Display a plot with an enlarged y-axis within a plot scaled from 0 to 100%. 

**Key arguments**

-   `formula` or `formulas` — one formula or a list of formulas; each entry creates a panel.
-   `data`, `outcome.type`, `code.events`, `type.y` — recycled across panels unless a list is supplied for per-panel control.
-   `rows.columns.panel` — selects grid layout by c(rows, cols).
-   `inset.panel` — selects inset layout.
-   `title.panel`, `subtitle.panel`, `caption.panel`, `title.plot` — overall titles and captions.
-   `tag.panel` — panel tag style (e.g., "A", "a", "1").
-   `label.x`, `label.y`, `limits.x`, `limits.y`, `breaks.x`, `breaks.y` — shared axis control unless a list is supplied for per-panel control. 

**Return**

-   A **patchwork** object (still ggplot-compatible).

**An example of usage**

In the first example, `cifplot()` called `cifpanel()` to combine multiple plots. `cifpanel()` is a function for creating a panel with multiple plots like this. `cifpanel()` can also display one plot inside another. The cumulative incidence probability for macrovascular complications is low, making it difficult to discern differences between groups. The following code uses `inset.panel=` to display plot `output2`, with an enlarged vertical axis, inside plot `output1`. The position and size of the zoomed-in-view panel is specified by `inset.left`, `inset.bottom`, `inset.right`, and `inset.top`. 

```{r example0-2, warning=FALSE, message=FALSE}
output1 <- cifplot(Event(t,epsilon) ~ fruitq,
                   data = diabetes.complications,
                   outcome.type="competing-risk",
                   code.event1=2,
                   code.event2=1,
                   add.ci = FALSE,
                   add.risktable = FALSE,
                   label.y="CIF of macrovascular complications",
                   label.x="Years from registration")
output2 <- cifplot(Event(t,epsilon) ~ fruitq,
                   data = diabetes.complications,
                   outcome.type="competing-risk",
                   code.event1=2,
                   code.event2=1,
                   add.ci = FALSE,
                   add.risktable = FALSE,
                   label.y="",
                   label.x="",
                   limits.y=c(0,0.15))
output3 <- list(a=output1, b=output2)
cifpanel(plots = output3,
         title.plot = c("Fruit intake and macrovascular complications", "Zoomed-in view"),
         inset.panel = TRUE,
         inset.left = 0.40, inset.bottom = 0.45,
         inset.right = 1.00, inset.top = 0.95,
         inset.legend.position = "none",
         legend.position = "bottom")
```

The code below, in which a formula and data is given directly, produces the same output as above. 

```{r example0-3, eval=FALSE, warning=FALSE, message=FALSE}
cifpanel(
 title.plot = c("Fruit intake and macrovascular complications", "Zoomed-in view"),
 inset.panel = TRUE,
 formula = Event(t, epsilon) ~ fruitq,
 data = diabetes.complications,
 outcome.type = "competing-risk",
 code.events = list(c(2,1,0), c(2,1,0)),
 label.y = c("CIF of macrovascular complications", ""),
 label.x = c("Years from registration", ""),
 limits.y = list(c(0,1), c(0,0.15)),
 inset.left = 0.40, inset.bottom = 0.45,
 inset.right = 1.00, inset.top = 0.95,
 inset.legend.position = "none",
 legend.position = "bottom", 
 add.ci = FALSE
)
```

### polyreg()

`polyreg()` implements **log odds product modeling** for CIFs at user-specified time points, focusing on multiplicative effects of a categorical exposure, or constant effects over time like Cox regression and Fine-Gray models. It estimates multiplicative effects such as **risk ratios**, **odds ratios**, or **subdistribution hazard ratios**, while ensuring that the probabilities across competing events sum to one. This is achieved through **reparameterization using polytomous log odds products**, which fits so-called effect-measure models and nuisance models on multiple competing events simultaneously. Additionally, `polyreg()` supports direct binomial regression for survival outcomes and the Richardson model for binomial outcomes, both of which use log odds products.

The function follows the familiar **formula + data** syntax with `Event()` or `Surv()` and outputs tidy results, including point estimates, standard errors, confidence intervals, and p-values. Its results can be easily summarized with `summary()` or combined with tools such as **modelsummary** or **broom** for reporting.

**Key arguments**

-   `nuisance.model` — a formula describing the outcome and nuisance covariates, excluding the exposure of interest. 
-   `exposure` — specifies the exposure variable. This argument accepts one binary or categorical variable.
-   `effect.measure1` and `effect.measure2` — specifies the effect measures for event1 and event2 (`"RR"`, `"OR"` or `"SHR"`). 
-   `outcome.type` selects the outcome type (`"competing-risk"`, `"survival"`, `"binomial"`, `"proportional-survival"` or `"proportional-competing-risk"`). 
-   `time.point` — specifies time points at which the exposure effect is evaluated. Required for `"competing-risk"` and `"survival"` outcomes.
-   `strata` — specifies the stratification variable used to adjust for dependent censoring. 

**Return**

-   `coefficient` — regression coefficients

-   `cov` — variance-covariance matrix for regression coefficients

-   `diagnostic.statistics` — a data frame containing inverse probability weights, influence functions, and predicted potential outcomes

-   `summary` — a summary of estimated exposure effects

### An example of usage

```{r example0-4, eval=FALSE, warning=FALSE, message=FALSE}
output <- polyreg(nuisance.model=Event(t,epsilon)~1, exposure="fruitq", 
          data=diabetes.complications, effect.measure1="RR", 
          effect.measure2="RR", time.point=8, outcome.type="competing-risk")
```

If you only need the core functionality of `cifcurve()` and `polyreg()`, installing `Rcpp` and `nleqslv` are enough; the other packages are optional but recommended to reproduce the examples below.
