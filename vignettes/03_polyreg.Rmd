---
title: "Direct polytomous modeling of CIFs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Direct polytomous modeling of CIFs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# Load required packages for the vignette
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/vignette-",
  fig.width  = 6,   
  fig.height = 4,   
  dpi        = 300,     
  fig.retina = 2,       
  out.width  = "70%",   
#  dev = "ragg_png",     
  comment = "#>"
)

.has_cifmodeling <- requireNamespace("cifmodeling", quietly = TRUE)
if (.has_cifmodeling) {
library(cifmodeling)
}
set.seed(1)
```

<!-- badges: start --> <!-- badges: end -->

```{r setup, include=FALSE, warning=FALSE}
#pak::pak("gestimation/cifmodeling")
#devtools::install_github("gestimation/cifmodeling") 
#library(cifmodeling)
library(nleqslv)
library(boot)
library(ggplot2)
library(ggsurvfit)
library(patchwork)
```

## Direct polytomous modeling of CIFs

The model for `polyreg()` is specified by three main components:

-   Nuisance model: Describes the relationship between outcomes and covariates (excluding exposure).

-   Effect measures and time points: Defines the exposure effect to be estimated and the time point of interest.

-   Censoring adjustment: Specifies strata for inverse probability weighting to adjust for dependent censoring.

**1. Nuisance Model**

The `nuisance.model` argument specifies the formula linking the outcome to covariates. Its format depends on the outcome type:

-   Competing risks or survival outcome: Use `Surv()` or `Event()` with time and status variables.

-   Binomial outcome: Use standard R formula notation.

Default event codes:

-   Competing risks outcome: 1 and 2 for event types, 0 for censoring.

-   Survival outcome: 1 for events, 0 for censoring.

-   Binomial outcome: 0 and 1.

Event codes can be customized using `code.event1`, `code.event2`, and `code.censoring`. The `outcome.type` argument must be set to:

-   Effects on cumulative incidence probabilities at a specific time: `"COMPETING-RISK"`

-   Effects on a risk at a specific time: `"SURVIVAL"`

-   Common effects on cumulative incidence probabilities over time: `"PROPORTIONAL-COMPETING-RISK"`

-   Common effects on a risk over time: `"PROPORTIONAL-SURVIVAL"`

-   Effects on a risk of a binomial outcome: `"BINOMIAL"`

Covariates included in `nuisance.model` should adjust for confounding factors to obtain unbiased exposure effect estimates.

**2. Effect measures and time points**

Three effect measures available:

-   Risk ratio (RR)

-   Odds ratio (OR)

-   Subdistribution hazard ratio (SHR)

Set the desired measure using `effect.measure1` and, for competing risks analysis, `effect.measure2`. The `time.point` argument specifies the follow-up time at which effects are estimated.

**3. Censoring adjustment**

Inverse probability weights adjust for dependent censoring. Use `strata=` to specify stratification variables. If no strata are specified, Kaplan-Meier weights are used.

**Return**

This function returns a list object that includes:

-   `coefficient` — regression coefficients

-   `cov` — variance-covariance matrix for regression coefficients

-   `diagnostic.statistics` — a data frame containing inverse probability weights, influence functions, and predicted potential outcomes

-   `summary` — a summary of estimated exposure effects

Use `summary` output with `msummary()` to display formatted results. The regression coefficients and their variance-covariance matrix are provided as `coefficient` and `cov`, respectively, with the first element corresponding to the intercept term, subsequent elements to the covariates in `nuisance.model`, and the last element to the variable specified by `exposure=`. Finally, `diagnostic.statistics` is a data frame containing inverse probability weights, influence functions, and predicted values of the potential outcomes of individual observations. 

